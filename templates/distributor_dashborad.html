<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distributor Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            margin: 0;
            padding: 0;
        }
        header {
            background: #28a745;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h2, h3 {
            margin: 0;
        }
        .section {
            margin: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            text-align: center;
        }
        .status {
            font-weight: bold;
        }
        .pending {
            color: orange;
        }
        .dispatched {
            color: green;
        }
        .outofstock {
            color: red;
        }
        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover { background: #218838; }
        .backup {
            background: #ffcccc;
        }
    </style>
</head>
<body>

<header>
    <h2>PharmaConnect - Distributor Dashboard</h2>
    <p>Welcome, Distributor #001</p>
</header>

<!-- Secret Code Section -->
<section class="section">
    <h3>Generate Secret Code for Pharmacy</h3>
    <button onclick="generateCode()">Generate Code</button>
    <p id="generatedCode" style="font-weight:bold; color:#007bff; margin-top:10px;"></p>
</section>

<!-- Current Stock Section -->
<section class="section">
    <h3>Current Stock</h3>
    <table id="stockTable">
        <thead>
            <tr>
                <th>Medicine</th>
                <th>Available Qty</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</section>

<!-- New Orders Section with Billing -->
<section class="section">
    <h3>New Orders</h3>
    <table id="newOrderTable">
        <thead>
            <tr>
                <th>Pharmacy</th>
                <th>Medicine List</th>
                <th>Total Bill</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</section>

<!-- Incoming Orders Section -->
<section class="section">
    <h3>Dispatched Orders</h3>
    <table id="orderTable">
        <thead>
            <tr>
                <th>Pharmacy</th>
                <th>Medicine</th>
                <th>Qty</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</section>

<script>
    // Stock Data
    let stock = [
        { medicine: "Paracetamol 500mg", qty: 25 },
        { medicine: "Amoxicillin 250mg", qty: 0 },
        { medicine: "Ibuprofen 400mg", qty: 40 },
        { medicine: "Vitamin C Tablets", qty: 10 },
        { medicine: "Azithromycin 500mg", qty: 10 }
    ];

    // New Orders with multiple medicines and prices
    let newOrders = [
        { 
            pharmacy: "City Care Pharmacy", 
            medicines: [
                { name: "Azithromycin 500mg", qty: 6, price: 12 },
                { name: "Ibuprofen 400mg", qty: 10, price: 5 }
            ], 
            status: "Pending" 
        },
        { 
            pharmacy: "LifeLine Meds", 
            medicines: [
                { name: "Amoxicillin 250mg", qty: 5, price: 8 },
                { name: "Paracetamol 500mg", qty: 10, price: 3 }
            ], 
            status: "Pending" 
        }
    ];

    let orders = [];

    function loadStock() {
        const tbody = document.querySelector("#stockTable tbody");
        tbody.innerHTML = "";
        stock.forEach(item => {
            let status = item.qty > 0 ? "In Stock" : "Out of Stock";
            let statusClass = item.qty > 0 ? "" : "outofstock";
            tbody.innerHTML += `
                <tr>
                    <td>${item.medicine}</td>
                    <td>${item.qty}</td>
                    <td class="${statusClass}">${status}</td>
                </tr>
            `;
        });
    }

    function loadNewOrders() {
        const tbody = document.querySelector("#newOrderTable tbody");
        tbody.innerHTML = "";
        newOrders.forEach((order, index) => {
            let medicineListHTML = "<ul>";
            let total = 0;
            let outOfStock = false;

            order.medicines.forEach(med => {
                let medStock = stock.find(s => s.medicine === med.name);
                if (!medStock || medStock.qty < med.qty) {
                    outOfStock = true;
                }
                let cost = med.qty * med.price;
                total += cost;
                medicineListHTML += `<li>${med.name} - ${med.qty} pcs × ₹${med.price} = ₹${cost}</li>`;
            });
            medicineListHTML += "</ul>";

            let actionButton = outOfStock 
                ? `<button onclick="requestBackup(${index})">Request Backup Distributor</button>` 
                : `<button onclick="sendPayment(${index})">Send Payment Request</button>`;

            tbody.innerHTML += `
                <tr class="${outOfStock ? 'backup' : ''}">
                    <td>${order.pharmacy}</td>
                    <td>${medicineListHTML}</td>
                    <td>₹${total}</td>
                    <td class="status ${order.status.toLowerCase()}">${order.status}</td>
                    <td>${actionButton}</td>
                </tr>
            `;
        });
    }

    function loadOrders() {
        const tbody = document.querySelector("#orderTable tbody");
        tbody.innerHTML = "";
        orders.forEach(o => {
            tbody.innerHTML += `
                <tr>
                    <td>${o.pharmacy}</td>
                    <td>${o.medicine}</td>
                    <td>${o.qty}</td>
                    <td class="status ${o.status.toLowerCase()}">${o.status}</td>
                </tr>
            `;
        });
    }

    function requestBackup(index) {
        alert(`Backup Distributor Request sent for ${newOrders[index].pharmacy}`);
    }

    function sendPayment(index) {
        alert(`Payment request sent to ${newOrders[index].pharmacy}`);
        newOrders[index].medicines.forEach(med => {
            orders.push({ pharmacy: newOrders[index].pharmacy, medicine: med.name, qty: med.qty, status: "Pending" });
        });
        newOrders.splice(index, 1);
        loadNewOrders();
        loadOrders();
    }

    // Secret Code Generator
    function generateCode() {
    fetch("/generate_distributor_code", { method: "POST" })
    .then(response => response.json())
    .then(data => {
        document.getElementById("generatedCode").innerText = `Secret Code: ${data.code}`;
        alert(`Secret Code generated: ${data.code}`);
    })
    .catch(err => console.error(err));
}
</script>

</body>
</html>
